<!DOCTYPE html>
<html lang="pt-BR" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RETORNO PRÉ MONTAGEM</title>
    <link rel="icon" type="image/png" href="imagem/GEQ.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* ==================== Estilos Gerais ==================== */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding-top: 120px;
            padding-bottom: 100px;
            
        }

        #backgroundImage{
            background-image: url('../imagem/tela-fogao-ideal.jpg'); /* Substitua 'sua-imagem.jpg' pelo nome e caminho da sua imagem */
            background-repeat: no-repeat; /* Para que a imagem não se repita */
            background-size: cover; /* Para a imagem cobrir toda a área do fundo */
            background-position: center; /* Para centralizar a imagem */
        }

    

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 180px;
        }

        .form-block {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
            /* Aumentando a intensidade da sombra */
            box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.3);
        }

        .form-block > form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        input[type="text"], input[type="time"], textarea {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .add-btn, .delete-btn, .export-btn {
            padding: 6px 12px;
            font-size: 18px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: transform 0.3s ease-in-out;
        }

        .add-btn {
            background: #4CAF50;
            color: white;
        }

        .delete-btn {
            background: #f44336;
            color: white;
        }

        .export-btn {
            background: #2196F3;
            color: white;
        }
        
        .add-btn:hover, .delete-btn:hover, .export-btn:hover {
            transform: scale(1.15);
        }
        
        /* Estilos específicos para o título e os indicadores */
        .form-block h4 {
            text-align: center;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .indicator {
            border-radius: 50%;
            display: inline-block;
            width: 1em;
            height: 1em;
            margin-left: 0.5em;
            border: 1px solid #ccc;
        }
        
        /* ==================== Estilos do Cabeçalho ==================== */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #0C296C;
            color: white;
            z-index: 1000;
            height: 80px;
            display: flex;
            align-items: center;
            padding: 0 30px;
        }
        
        header img {
            width: 230px;
            height: auto;
            margin-right: 20px;
        }
        
        header h2 {
            margin: 0;
            font-size: 40px;
            font-family: 'Montserrat', sans-serif;
            text-align: center;
            flex-grow: 1;
        }
        
        .header-spacer {
            width: 250px;
            visibility: hidden;
        }

        /* ==================== Estilos do Rodapé Fixo ==================== */
        #footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }
        
        #footer-container {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #footer .left-buttons {
            display: flex;
            gap: 10px;
        }

        /* ==================== Responsividade (Mobile) ==================== */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }

            .form-group {
                min-width: unset;
            }

            header {
                padding: 0 15px;
            }

            header img {
                display: none;
            }

            header h2 {
                font-size: 24px;
            }

            .header-spacer {
                display: none;
            }

            #footer-container {
                flex-direction: column-reverse;
                gap: 15px;
                padding-bottom: 25px;
            }
            
            #footer .left-buttons {
                justify-content: center;
                width: 100%;
            }
        }
    </style>

<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:_dlc_DocId msdt:dt="string">VZAP3WSKN6VM-1727332100-12386674</mso:_dlc_DocId>
<mso:_dlc_DocIdItemGuid msdt:dt="string">85cd1492-5593-458b-b63f-a78e7ca6ca29</mso:_dlc_DocIdItemGuid>
<mso:_dlc_DocIdUrl msdt:dt="string">https://grupoedsonqueiroz.sharepoint.com/sites/esmaltec.mrc/_layouts/15/DocIdRedir.aspx?ID=VZAP3WSKN6VM-1727332100-12386674, VZAP3WSKN6VM-1727332100-12386674</mso:_dlc_DocIdUrl>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>
<body id="backgroundImage">

    <header>
        <img src="imagem/baixados.png" alt="Logo">
        <h2>FORMULÁRIO RETORNO DE ESTOQUE SEMI-AUTOMÁTICO</h2>
        <div class="header-spacer"></div>
    </header>

    <div class="container">
        <div id="form-container"></div>
    </div>
    
    <div id="footer">
        <div id="footer-container">
            <div class="left-buttons">
                <button type="button" class="add-btn" id="add-line">+</button>
                <button type="button" class="delete-btn" id="delete-line">-</button>
            </div>
            <button type="button" class="export-btn" id="export-excel">Exportar Excel</button>
        </div>
    </div>

    <script>
        // ==================== Referências do DOM ====================
        const container = document.getElementById("form-container");
        const addBtn = document.getElementById("add-line");
        const deleteBtn = document.getElementById("delete-line");
        const exportBtn = document.getElementById("export-excel");

        // ==================== Funções de Manipulação ====================
        function atualizarTitulos() {
            container.querySelectorAll(".form-block").forEach((block, index) => {
                block.querySelector("h4").childNodes[0].nodeValue = `Pré-montagem ${index + 1} `;
            });
        }

        function salvarCampos() {
            const dados = [];
            container.querySelectorAll(".form-block").forEach(block => {
                const linha = {};
                block.querySelectorAll("input, textarea").forEach(input => {
                    if (input.type === "checkbox") {
                        linha[input.name] = input.checked;
                    } else {
                        linha[input.name] = input.value;
                    }
                });
                dados.push(linha);
            });
            localStorage.setItem("formData", JSON.stringify(dados));
            localStorage.setItem("savedDate", new Date().toISOString().split("T")[0]);
            atualizarIndicadores();
        }

        function carregarCampos() {
            const hoje = new Date().toISOString().split("T")[0];
            const dataSalva = localStorage.getItem("savedDate");

            if (dataSalva !== hoje) {
                localStorage.clear();
                container.innerHTML = "";
                container.appendChild(criarFormulario());
                atualizarTitulos();
                salvarCampos();
                return;
            }

            const dadosSalvos = JSON.parse(localStorage.getItem("formData") || "[]");

            if (dadosSalvos.length > 0) {
                container.innerHTML = "";
                dadosSalvos.forEach(linha => {
                    const formBlock = criarFormulario();
                    for (let campo in linha) {
                        const input = formBlock.querySelector(`[name='${campo}']`);
                        if (input) {
                            if (input.type === "checkbox") {
                                input.checked = linha[campo];
                            } else {
                                input.value = linha[campo];
                            }
                        }
                    }
                    container.appendChild(formBlock);
                });
                atualizarTitulos();
                atualizarIndicadores();
            } else {
                container.appendChild(criarFormulario());
                atualizarTitulos();
            }
        }

        function criarFormulario() {
            const formBlock = document.createElement("div");
            formBlock.classList.add("form-block");

            formBlock.innerHTML = `
                <h4>
                    Pré-montagem <span>
                        <span class="indicator"></span>
                        <span class="indicator"></span>
                        <span class="indicator"></span>
                    </span>
                </h4>
                <form>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Solicitante:</label>
                            <input type="text" name="solicitante[]">
                        </div>
                        <div class="form-group">
                            <label>Pré-montagem:</label>
                            <input type="text" name="premontagem[]">
                        </div>
                        <div class="form-group">
                            <label>Ordem:</label>
                            <input type="text" name="ordem[]">
                        </div>
                        <div class="form-group">
                            <label>Distribuição:</label>
                            <input type="text" name="distribuicao[]">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Horário Inicial:</label>
                            <input type="time" name="horario_inicial[]">
                        </div>
                        <div class="form-group">
                            <label>Horário Final:</label>
                            <input type="time" name="horario_final[]">
                        </div>
                        <div class="form-group">
                            <label>Observação:</label>
                            <textarea name="observacao[]"></textarea>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" name="finalizado[]">
                                <label>Atividade Finalizada</label>
                            </div>
                        </div>
                    </div>
                </form>
            `;

            formBlock.querySelectorAll("input, textarea, input[type='checkbox']").forEach(input => {
                input.addEventListener("input", salvarCampos);
                input.addEventListener("blur", salvarCampos);
            });

            return formBlock;
        }

        function atualizarIndicadores() {
            container.querySelectorAll(".form-block").forEach(block => {
                const indicators = block.querySelectorAll(".indicator");
                const premontagemInput = block.querySelector("input[name='premontagem[]']");
                const horarioInicialInput = block.querySelector("input[name='horario_inicial[]']");
                const finalizadoCheckbox = block.querySelector("input[name='finalizado[]']");

                indicators.forEach(indicator => indicator.style.backgroundColor = "white");

                if (premontagemInput.value.trim() !== "") {
                    indicators[0].style.backgroundColor = "yellow";
                }

                if (horarioInicialInput.value && !finalizadoCheckbox.checked) {
                    const [hour, minute] = horarioInicialInput.value.split(':').map(Number);
                    const startTime = new Date();
                    startTime.setHours(hour, minute, 0, 0);

                    const currentTime = new Date();
                    const diffInMinutes = (currentTime - startTime) / (1000 * 60);

                    if (diffInMinutes > 30) {
                        indicators[0].style.backgroundColor = "white";
                        indicators[1].style.backgroundColor = "red";
                    }
                }

                if (finalizadoCheckbox.checked) {
                    indicators[0].style.backgroundColor = "white";
                    indicators[1].style.backgroundColor = "white";
                    indicators[2].style.backgroundColor = "green";
                }
            });
        }

        // ==================== Event Listeners dos Botões ====================
        addBtn.addEventListener("click", () => {
            container.appendChild(criarFormulario());
            atualizarTitulos();
            salvarCampos();
        });

        deleteBtn.addEventListener("click", () => {
            const linhas = container.querySelectorAll(".form-block");
            if (linhas.length > 1) {
                const ultimaLinha = linhas[linhas.length - 1];
                let hasContent = false;
                
                ultimaLinha.querySelectorAll("input, textarea").forEach(input => {
                    if (input.type === "checkbox") {
                        if (input.checked) {
                            hasContent = true;
                        }
                    } else {
                        if (input.value.trim() !== "") {
                            hasContent = true;
                        }
                    }
                });

                if (hasContent) {
                    alert("O formulário tem informações preenchidas e não é possível excluir.");
                } else {
                    container.removeChild(ultimaLinha);
                    atualizarTitulos();
                    salvarCampos();
                }
            }
        });

        exportBtn.addEventListener("click", () => {
            const dados = [];
            document.querySelectorAll(".form-block").forEach(block => {
                const linha = {};
                block.querySelectorAll("input, textarea").forEach(input => {
                    const key = input.name.replace("[]", "");
                    if (input.type === "checkbox") {
                        linha[key] = input.checked ? "Sim" : "Não";
                    } else {
                        linha[key] = input.value;
                    }
                });
                dados.push(linha);
            });

            const dadosParaPlanilha = dados.map((linha, index) => {
                return [
                    index + 1,
                    linha.solicitante,
                    linha.premontagem,
                    linha.ordem,
                    linha.distribuicao,
                    linha.horario_inicial,
                    linha.horario_final,
                    linha.observacao,
                    linha.finalizado
                ];
            });
            
            const cabecalho = [
                "Qtd de equalizações", "Solicitante", "Pré-montagem", "Ordem", "Distribuição",
                "Horário Inicial", "Horário Final", "Observação", "Atividade Finalizada"
            ];

            const worksheet = XLSX.utils.aoa_to_sheet([cabecalho, ...dadosParaPlanilha]);

            const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
            for (let C = headerRange.s.c; C <= headerRange.e.c; ++C) {
                const cellRef = XLSX.utils.encode_cell({ c: C, r: 0 });
                if (!worksheet[cellRef]) continue;
                if (!worksheet[cellRef].s) worksheet[cellRef].s = {};
                if (!worksheet[cellRef].s.font) worksheet[cellRef].s.font = {};
                worksheet[cellRef].s.font.bold = true;
            }

            worksheet['!cols'] = [
                { wch: 17 }, // Qtd de equalizações
                { wch: 30 }, // Solicitante
                { wch: 12 }, // Pré-montagem
                { wch: 12 }, // Ordem
                { wch: 12 }, // Distribuição
                { wch: 12 }, // Horário Inicial
                { wch: 12 }, // Horário Final
                { wch: 30 }, // Observação
                { wch: 17 }  // Atividade Finalizada
            ];

            const workbook = XLSX.utils.book_new();
            
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            
            const filename = `formulario-${formattedDate}.xlsx`;

            XLSX.utils.book_append_sheet(workbook, worksheet, "Formulário");
            XLSX.writeFile(workbook, filename);
        });

        // ==================== Inicialização da Página ====================
        carregarCampos();
    </script>
</body>
</html>


